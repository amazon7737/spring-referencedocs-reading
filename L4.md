## 애플리케이션 레벨에 요청을 받을때, L4에서 일어나는 일에 대해서

L4 전송 계층의 구성과 역할

<img width="781" height="273" alt="image" src="https://github.com/user-attachments/assets/d742e0f8-30f8-4580-8015-a2bc04428498" />

L4 계층은 스위치, 로드밸런서로 구성되어있다. TCP/UDP 프로토콜의 IP와 포트 정보를 기반으로 들어오는 클라이언트 요청을 여러 웹 서버나 WAS로 부하 분산한다.

- 동작 원리
  - 클라이언트는 L4 스위치의 가상 IP로 요청을 보낸다.
  - L4 스위치는 각 요청의 목적지 IP, 포트, 프로토콜 정보를 파악해 실 서버(리얼 IP) 중 하나를 선택해 패킷을 전달한다.
  - 이 과정에서 Round Robin, Least Connection 등 다양한 분산 알고리즘이 적용될 수 있다.
  - TCP 3-way handshake도 L4를 통해 중개된다.

### 정리

사용자 요청이 L4 스위치/로드밸런서를 통해서 서버에 분배되는 것이 맞으며, 이는 현대 웹 서비스에서 일반적인 실질적으로 필요한 네트워크 구조이다. L4 구성은 네트워크 엔지니어링에서 표준적인 방법이다.

## L4 에서의 포트와 소켓 동작
---

L4 에서 포트와 소켓은 네트워크 내 애플리케이션 간 통신을 연결.식별하는 핵심 역할을 한다.

포트의 역할
- 포트는 각 애플리케이션 프로세스를 식별한다 (0~65535 의 숫자로 2byte)
- 같은 서버 내에서 서로 다른 서비스(웹 80, DB 3306, FTP 21)에 대한 요청을 구분해 전달하는 데 사용된다.
- L4 스위치나 네트워크 장비는 IP 주소 + 포트(<IP, Port>) 기반으로 트래픽 분배 및 호출 처리를 수행한다.

소켓의 동작
소켓은 IP 주소와 포트, 프로토콜을 조합한 엔드포인트이다.
서버 쪽에서 지정된 포트에 바인딩하여 연결 요청을 대기(listening socket), 클라이언트는 임시 포트로 서버의 포트에 연결(connect) 시도한다.
서버는 연결을 받아들이면 각 클라이언트의 통신을 관리하기 위한 새로운 소켓(세션)이 생성되어, 독립적으로 데이터 송수신이 이루어진다.
소켓은 메모리 공간에 IP.포트 정보를 저장하며, 각 연결은 핸들값(소켓 핸들)로 관리한다.

### 정리

L4에서 포트는 프로세스의 식별을, 소켓은 연결 세션의 통신 통로 역할을 한다. 이 둘을 결합시켜 개별 요청을 정확하게 구분한다.

## 애플리케이션 서버가 요청을 받기 전에, 이루어지는 네트워크 상의 동작

이번 정리에서는, 애플리케이션 레벨인 WAS가 요청을 받기전에 Web Server에 도달하는 요청을 L4에서 어떤식으로 처리하는지에 대해서 정리해볼 것이다.

<img width="657" height="152" alt="image" src="https://github.com/user-attachments/assets/6c878a4d-5aec-42ff-a366-dcfc032fc21d" />

- 사용자가 브라우저를 통해서 접속을 진행할때, 브라우저는 네트워크를 타고 L4 전송계층에 도달하게 됩니다.
- 사용자는 IP, 포트(80, 443) 기준으로 TCP 연결을 통해 서버에 요청을 전송합니다. L4 는 처리 영역에 해당합니다.

<img width="281" height="263" alt="image" src="https://github.com/user-attachments/assets/e3ba23fb-432d-45a6-b78e-210bf2ab3724" />

- L4에는 스위치나 로드밸런서와 같은 것이 구성되어있고, IP와 포트 정보를 기반으로 요청한 적절한 서버로 전달합니다.

<img width="695" height="413" alt="image" src="https://github.com/user-attachments/assets/a696b24a-232e-40c8-861c-af2a16feeabe" />

<img width="675" height="466" alt="image" src="https://github.com/user-attachments/assets/b69d0ad6-e03d-4c59-b3b7-1b0d442f5b71" />

- 서버 내에서는 보통 웹서버(Web Server) 또는 내장 서블릿 컨테이너(Tomcat)가 L4에서 전달받은 요청을 소켓을 통해서 받습니다.
- HTTP 프로토콜 수준으로 요청메시지를 파싱하게 됩니다.

##### 최초 요청은 어떻게 처리되나요?

아래 그림은, 애플리케이션 레벨에 최초로 도달했을때의 요청 처리를 보여줍니다.

<img width="572" height="438" alt="image" src="https://github.com/user-attachments/assets/c06671c7-abf1-4066-9602-f86ff7ca3763" />

- 먼저 L4 전송계층에 있는 TCP/IP 포트와 소켓에서 요청을 받고, WAS의 Tomcat은 OS의 소켓을 통해서 TCP 연결 요청을 받습니다.
- OS 네트워크 스택에서 소켓이 열려서 클라이언트의 TCP 연결 요청을 수신하고, Tomcat 같은 컨테이너는 소켓을 바인딩하여 클라이언트와 연결을 맺고, 받은 요청 데이터를 HTTP 프로토콜로 해석해서 DispatcherServlet으로 넘깁니다.
- Tomcat의 자세한 동작 설명을 보고싶다면, [Tomcat이 요청을 받는 순서](https://github.com/amazon7737/spring-referencedocs-reading/blob/main/tomcat.md)에 있습니다.


