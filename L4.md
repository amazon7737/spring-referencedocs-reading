## 애플리케이션 레벨에 요청을 받을때, L4에서 일어나는 일에 대해서

L4 전송 계층의 구성과 역할

<img width="781" height="273" alt="image" src="https://github.com/user-attachments/assets/d742e0f8-30f8-4580-8015-a2bc04428498" />

L4 계층은 스위치, 로드밸런서로 구성되어있다. TCP/UDP 프로토콜의 IP와 포트 정보를 기반으로 들어오는 클라이언트 요청을 여러 웹 서버나 WAS로 부하 분산한다.

- 동작 원리
  - 클라이언트는 L4 스위치의 가상 IP로 요청을 보낸다.
  - L4 스위치는 각 요청의 목적지 IP, 포트, 프로토콜 정보를 파악해 실 서버(리얼 IP) 중 하나를 선택해 패킷을 전달한다.
  - 이 과정에서 Round Robin, Least Connection 등 다양한 분산 알고리즘이 적용될 수 있다.
  - TCP 3-way handshake도 L4를 통해 중개된다.
 
IP와 포트 정보를 기반으로 요청한 적절한 서버로 전달한다.

<img width="695" height="413" alt="image" src="https://github.com/user-attachments/assets/a696b24a-232e-40c8-861c-af2a16feeabe" />

<img width="675" height="466" alt="image" src="https://github.com/user-attachments/assets/b69d0ad6-e03d-4c59-b3b7-1b0d442f5b71" />

- 서버 내에서는 보통 웹서버(Web Server) 또는 내장 서블릿 컨테이너(Tomcat)가 L4에서 전달받은 요청을 소켓을 통해서 받습니다.
- HTTP 프로토콜 수준으로 요청메시지를 파싱하게 됩니다.

##### 최초 요청은 어떻게 처리되나요?

아래 그림은, 애플리케이션 레벨에 최초로 도달했을때의 요청 처리를 보여줍니다.

<img width="572" height="438" alt="image" src="https://github.com/user-attachments/assets/c06671c7-abf1-4066-9602-f86ff7ca3763" />

- 먼저 L4 전송계층에 있는 TCP/IP 포트와 소켓에서 요청을 받고, WAS의 Tomcat은 OS의 소켓을 통해서 TCP 연결 요청을 받습니다.
- OS 네트워크 스택에서 소켓이 열려서 클라이언트의 TCP 연결 요청을 수신하고, Tomcat 같은 컨테이너는 소켓을 바인딩하여 클라이언트와 연결을 맺고, 받은 요청 데이터를 HTTP 프로토콜로 해석해서 DispatcherServlet으로 넘깁니다.
- Tomcat의 자세한 동작 설명을 보고싶다면, [Tomcat이 요청을 받는 순서](https://github.com/amazon7737/spring-referencedocs-reading/blob/main/tomcat.md)에 있습니다.

### 정리

사용자 요청이 L4 스위치/로드밸런서를 통해서 서버에 분배되는 것이 맞으며, 이는 현대 웹 서비스에서 일반적인 실질적으로 필요한 네트워크 구조이다. L4 구성은 네트워크 엔지니어링에서 표준적인 방법이다.
