## 애플리케이션 레벨에 요청을 받을때, L4에서 일어나는 일에 대해서

L4 전송 게층의 핵심 동작

- L4 계층에는 TCP 와 UDP 프로토콜이 존재한다.
- 클라이언트가 서버로 요청 시, 서버의 IP 주소와 함께 포트 번호가 지정된다. 포트 번호에 따라 서버의 여러 애플리케이션 중 어떤 서비스로 요청이 전달될지 결정된다.
- TCP 는 3-way handshake 과정을 통해 연결을 성립시키고, 신뢰성 있는 데이터 송수신을 보장한다. UDP는 비연결성으로써, 빠르지만 신뢰성이 낮으며 사용자가 직접 요청 구조를 변경할 수 있다.
- 연결이 성립되고 나면, 전송 계층이 데이터의 손실/중복/순서를 관리하며, 여러 애플리케이션 프로세스에 정확한 데이터 전달(프로세스 간 논리적 통신)을 수행한다.

L4 스위칭 관점의 처리
L4 스위치(로드밸런서)는 IP 주소뿐 아니라 포트 번호(80, 443, 8080) 와 프로토콜(TCP/UDP)을 근거로 패킷을 분기하거나 트래픽 분산, 서버 선택 등의 네트워크 처리를 한다.
서버 그룹 앞에 VIP(가상 IP)를 두고 들어온 요청의 목적 포트에 따라 실제 서버로 매핑하여 전달한다.
매 세션마다 소스/목적지 IP, 포트 , 프로토콜 정보를 기반으로 트래픽 경로를 결정한다.

### 처리 과정
1. 클라이언트가 서버에 TCP 연결 요청 (서버 IP 192.168.1.10:80)
2. L4 계층에서 포트 번호, IP와 함께 TCP 연결을 생성(3-way handshake)
3. 연결 정보에 따라 해당 애플리케이션(웹서버)이 요청 패킷을 수신
4. 데이터 송수신 과정에서 L4 계층은 데이터의 신뢰성, 순서, 오류 검증, 흐름 제어 등을 담당
5. 응용 계층으로 데이터가 전달돼 애플리케이션이 실제 요청을 처리하게 됨

### 정리

L4에서는 TCP/UDP 기반의 포트 번호를 활용하여 애플리케이션 간에 논리적 연결을 성립시키고, 신뢰성.순서.오류 검증 등 데이터 전송의 핵심 제어를 담당한다. 네트워크 장비에서는 L4 정보로 트래픽 분배, 서버 선택 등의 분산 처리가 이루어진다.


## L4 에서의 포트와 소켓 동작
---

L4 에서 포트와 소켓은 네트워크 내 애플리케이션 간 통신을 연결.식별하는 핵심 역할을 한다.

포트의 역할
- 포트는 각 애플리케이션 프로세스를 식별한다 (0~65535 의 숫자로 2byte)
- 같은 서버 내에서 서로 다른 서비스(웹 80, DB 3306, FTP 21)에 대한 요청을 구분해 전달하는 데 사용된다.
- L4 스위치나 네트워크 장비는 IP 주소 + 포트(<IP, Port>) 기반으로 트래픽 분배 및 호출 처리를 수행한다.

소켓의 동작
소켓은 IP 주소와 포트, 프로토콜을 조합한 엔드포인트이다.
서버 쪽에서 지정된 포트에 바인딩하여 연결 요청을 대기(listening socket), 클라이언트는 임시 포트로 서버의 포트에 연결(connect) 시도한다.
서버는 연결을 받아들이면 각 클라이언트의 통신을 관리하기 위한 새로운 소켓(세션)이 생성되어, 독립적으로 데이터 송수신이 이루어진다.
소켓은 메모리 공간에 IP.포트 정보를 저장하며, 각 연결은 핸들값(소켓 핸들)로 관리한다.

### 정리

L4에서 포트는 프로세스의 식별을, 소켓은 연결 세션의 통신 통로 역할을 한다. 이 둘을 결합시켜 개별 요청을 정확하게 구분한다.

## 애플리케이션 서버가 요청을 받기 전에, 이루어지는 네트워크 상의 동작

이번 정리에서는, 애플리케이션 레벨인 WAS가 요청을 받기전에 Web Server에 도달하는 요청을 L4에서 어떤식으로 처리하는지에 대해서 정리해볼 것이다.

<img width="657" height="152" alt="image" src="https://github.com/user-attachments/assets/6c878a4d-5aec-42ff-a366-dcfc032fc21d" />

- 사용자가 브라우저를 통해서 접속을 진행할때, 브라우저는 네트워크를 타고 L4 전송계층에 도달하게 됩니다.
- 사용자는 IP, 포트(80, 443) 기준으로 TCP 연결을 통해 서버에 요청을 전송합니다. L4 는 처리 영역에 해당합니다.

<img width="281" height="263" alt="image" src="https://github.com/user-attachments/assets/e3ba23fb-432d-45a6-b78e-210bf2ab3724" />

- L4에는 스위치나 로드밸런서와 같은 것이 구성되어있고, IP와 포트 정보를 기반으로 요청한 적절한 서버로 전달합니다.

<img width="695" height="413" alt="image" src="https://github.com/user-attachments/assets/a696b24a-232e-40c8-861c-af2a16feeabe" />

<img width="675" height="466" alt="image" src="https://github.com/user-attachments/assets/b69d0ad6-e03d-4c59-b3b7-1b0d442f5b71" />

- 서버 내에서는 보통 웹서버(Web Server) 또는 내장 서블릿 컨테이너(Tomcat)가 L4에서 전달받은 요청을 소켓을 통해서 받습니다.
- HTTP 프로토콜 수준으로 요청메시지를 파싱하게 됩니다.

##### 최초 요청은 어떻게 처리되나요?

아래 그림은, 애플리케이션 레벨에 최초로 도달했을때의 요청 처리를 보여줍니다.

<img width="572" height="438" alt="image" src="https://github.com/user-attachments/assets/c06671c7-abf1-4066-9602-f86ff7ca3763" />

- 먼저 L4 전송계층에 있는 TCP/IP 포트와 소켓에서 요청을 받고, WAS의 Tomcat은 OS의 소켓을 통해서 TCP 연결 요청을 받습니다.
- OS 네트워크 스택에서 소켓이 열려서 클라이언트의 TCP 연결 요청을 수신하고, Tomcat 같은 컨테이너는 소켓을 바인딩하여 클라이언트와 연결을 맺고, 받은 요청 데이터를 HTTP 프로토콜로 해석해서 DispatcherServlet으로 넘깁니다.
- Tomcat의 자세한 동작 설명을 보고싶다면, [Tomcat이 요청을 받는 순서](https://github.com/amazon7737/spring-referencedocs-reading/blob/main/tomcat.md)에 있습니다.

<img width="1144" height="542" alt="image" src="https://github.com/user-attachments/assets/ba6359e0-20de-46fe-86a0-872d57019859" />


- DispatcherServlet
  - Spring MVC의 앞단 컨트롤러 역할을 하는 클래스입니다.
  - 요청들을 받아, 어떤 Handler(Controller)로 넘길지 결정합니다.

- Handler(Controller)
- 요청 URL과 메서드(GET/POST 등) 를 기반으로 요청을 핸들러 메서드에 매핑해줍니다.
- 요청 데이터 검증, 서비스 계층 호출을 담당합니다.

#### View 계층

- View Resolver
  - Controller에서 반환한 결과를 어떤 View로 렌더링할지 결정합니다.
  - JSP, Thymeleaf, JSON 등.. 다양한 뷰타입을 지원
 
- View
  - 사용자에게 응답할 HTML, JSON, XML 등의 데이터입니다.


### 정리

<img width="1352" height="492" alt="image" src="https://github.com/user-attachments/assets/a3f3e6eb-cfa3-43ad-95cf-f5b4bf6aeaea" />

Spring MVC 는 L4(전송계층), Web Server, WAS(Web Application Server), Servlet, Spring MVC(Filter, DispatcherServlet, Controller, Service, Repository, DB, View Resolver, View) 와 같은 모듈별의 구조를 이루는 아키텍처를 정리해보았습니다. 이후에는 각 모듈별에 대한 자세한 동작과 역할들에 대해서 알아보면 좋을 것 같습니다.
